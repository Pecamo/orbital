<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Orbital</title>
    <link href="https://fonts.googleapis.com/css?family=Montserrat&display=swap" rel="stylesheet">
    <style>
        @font-face {
            font-family: 'Montserrat';
            font-display: swap;
            src: local('Montserrat Regular'), local('Montserrat-Regular'), url('/static/Montserrat.woff2') format('woff2');
            unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
        }

        :root {
            --base-color-bg: #8e8e8e;
            --base-color-fg: #ffffff;
        }

        body {
            position: absolute;
            width: 100%;
            height: 100%;
            margin: 0;
            font-size: 4vw;
            font-family: Montserrat, sans-serif;
        }

        .background {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: #000000;
            transition: 1s all;
            position: absolute;
            z-index: -1;
        }

        .scene {
            width: 100%;
            height: 100%;
            display: none;
            position: relative;
            justify-content: space-between;
            color: var(--base-color-fg);
        }

        .scene.active {
            display: flex !important;
        }

        #container {
            width: 100%;
            height: 100%;
        }

        #welcome {
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            color: var(--base-color-fg);
        }

        #welcome .button {
            font-size: 6vw;
            padding: 2vw;
        }

        #welcome .button:disabled {
            opacity: 0.4;
        }

        #welcome .orbital {
            font-size: 4vw;
            margin-bottom: 2vw;
        }

        #play .button {
            background-color: var(--base-color-bg);
            color: var(--base-color-fg);
            justify-content: center;
            align-items: center;
            font-size: 20vw;
            flex-grow: 1;
            height: 100%;
            border: 0;
            max-width: 32%;
        }

        #wait, #getReady, #won, #lost, #gameInProgress {
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .button {
            background-color: var(--base-color-bg);
            font-family: Montserrat, sans-serif;
            display: flex;
            color: var(--base-color-fg);
            justify-content: center;
            align-items: center;
            border: 0;
        }

        .button:active {
            opacity: 0.6;
        }

        .button:focus {
            border: 0;
            outline: 0;
        }

        .fire {
            font-size: 25vw;
        }

        .left {
        }

        .right {
        }
    </style>
</head>
<body>
    <script>
        state = {
            activeScene: 'welcome'
        };

        changeBaseColorFG = (color) => {
            root.style.setProperty('--base-color-fg', color);
        };

        changeBaseColorBG = (color) => {
            root.style.setProperty('--base-color-bg', color);
        };

        activateScene = (scene) => {
            if (!['welcome', 'wait', 'getReady', 'play', 'won', 'lost', 'gameInProgress']
                .includes(scene)) {
                console.error("This scene doesn't exist");
                return;
            }
            state.activeScene = scene;
            document
              .querySelectorAll('.scene')
              .forEach(e => e.classList.remove('active'));
            document
              .querySelector('#' + scene).classList.add('active');
        };

        baseGray = 'bbb';
        waitTime = 60;

        ws = new WebSocket("ws://" + location.host + "/");

        sendJSON = (message) => () => {
            ws.send(JSON.stringify(message));
        };

        onJoinRelease = () => {
            document.querySelector('#joinButton').setAttribute('disabled', true);
            onJoin();
        };

        onJoinDisappear = () => {
            document.querySelector('#joinButton').removeAttribute('disabled');
        };

        onJoin = sendJSON({cmd: 'join'});
        onLeftPress = sendJSON({cmd: 'press', data: 'left'});
        onLeftRelease = sendJSON({cmd: 'release', data: 'left'});
        onRightPress = sendJSON({cmd: 'press', data: 'right'});
        onRightRelease = sendJSON({cmd: 'release', data: 'right'});
        onFirePress = sendJSON({cmd: 'press', data: 'fire'});
        onFireRelease = sendJSON({cmd: 'release', data: 'fire'});

        setWaitTime = (newTime) => {
            waitTime = newTime;
            document.querySelector('#startsIn').innerHTML = newTime;
        };

        decreaseWaitDaemon = () => {
            if (state.activeScene === 'getReady') {
                waitTime = Math.max(waitTime - 1, 0);
                document.querySelector('#startsIn').innerHTML = waitTime;
            }
        };

        setInterval(decreaseWaitDaemon, 1000);

        onRecieve = (message) => {
            var json = JSON.parse(message);
            if (!json.cmd) {
                console.error("Invalid message recieved");
                return;
            }
            joinPressed = false;
            switch (json.cmd) {
                case 'welcome': {
                    activateScene('welcome');
                    changeBaseColorBG(baseGray);
                    break;
                }

                case 'wait': {
                    activateScene('wait');
                    break;
                }

                case 'getReady': {
                    activateScene('getReady');
                    setWaitTime(json.data);
                    changeBaseColorBG(message.color);
                    break;
                }

                case 'play': {
                    activateScene('play');
                    changeBaseColorBG(message.color);
                    break;
                }

                case 'won': {
                    activateScene('won');
                    break;
                }

                case 'lost': {
                    activateScene('lost');
                    break;
                }

                case 'gameInProgress': {
                    activateScene('gameInProgress');
                    break;
                }
            }
        }
    </script>
    <div id="container">
        <div class="scene active" id="welcome">
            <div class="background"></div>
            Welcome to
            <div class="orbital">ORBITAL</div>
            <button class="button" id="joinButton" onmouseup="onJoinRelease()">
                Join a game
            </button>
        </div>
        <div class="scene" id="wait">
            <div class="background"></div>
            Waiting for an opponent to connect...
        </div>
        <div class="scene" id="getReady">
            <div class="background"></div>
            <p>Waiting for the game to start...</p>
            <p>Starting in ~<span id="startsIn">60</span> sec</p>
        </div>
        <div class="scene" id="play">
            <div class="background"></div>
            <button class="left button" onmousedown="onLeftPress()" onmouseup="onLeftRelease()">
                ðŸ¢€
            </button>
            <button class="fire button" onmousedown="onFirePress()" onmouseup="onFireRelease()">
                â¯Œ
            </button>
            <button class="right button" onmousedown="onRightPress()" onmouseup="onRightRelease()">
                ðŸ¢‚
            </button>
        </div>
        <div class="scene" id="won">
            <div class="background"></div>
            <p>CONGRATULATIONS</p>
            <p>You won !</p>
        </div>
        <div class="scene" id="lost">
            <div class="background"></div>
            <p>GAME OVER</p>
            <p>You died.</p>
        </div>
        <div class="scene" id="gameInProgress">
            <div class="background"></div>
            <p>A game is currently in progress.</p>
            <p>Spectate and be ready for the next game !</p>
        </div>
    </div>
</body>
</html>
