<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0'/>
    <title>Orbital</title>
    <style>
        @font-face {
            font-family: 'Montserrat';
            font-display: swap;
            src: local('Montserrat Regular'), local('Montserrat-Regular'), url('/static/Montserrat.woff2') format('woff2');
            unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
        }

        @keyframes slowMove {
            0% {
                transform: translate(0%, 0%);
            }
            100% {
                transform: translate(10%, 0%);
            }
        }

        * {
          -webkit-touch-callout: none; /* iOS Safari */
            -webkit-user-select: none; /* Safari */
              -khtml-user-select: none; /* Konqueror HTML */
                -moz-user-select: none; /* Firefox */
                -ms-user-select: none; /* Internet Explorer/Edge */
                    user-select: none; /* Non-prefixed version, currently
                                          supported by Chrome and Opera */
        }

        #allBackground {
            position: absolute;
            width: 120%;
            margin-left: -20%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-content: space-around;
            opacity: 0.2;
            overflow: hidden;
        }

        #allBackground * {
            overflow: hidden;
        }

        #allBackground .strip {
            width: 100%;
            height: 5vh;
            display: flex;
            align-items: center;
            flex-wrap: nowrap;
            justify-content: space-around;
            animation: slowMove 4s;
            animation-timing-function: linear;
            animation-iteration-count: infinite;
        }

        #allBackground .led {
            height: 2.5vh;
            width: 1.5vw;
            background-color: var(--base-color-bg);
            box-shadow: 0 0 10px 5px var(--base-color-bg);
            transition: all 1s;
        }

        :root {
            --base-color-bg: #8e8e8e;
            --base-color-fg: #ffffff;
        }

        body {
            position: absolute;
            width: 100%;
            height: 100%;
            margin: 0;
            font-size: 4vw;
            font-family: Montserrat, sans-serif;
        }

        .background {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: #000000;
            transition: 1s all;
            position: absolute;
            z-index: -1;
        }

        .scene {
            width: 100%;
            height: 100%;
            display: none;
            position: relative;
            justify-content: space-between;
            color: var(--base-color-fg);
        }

        .scene.active {
            display: flex !important;
        }

        #container {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        #welcome {
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            color: var(--base-color-fg);
        }

        #welcome .button {
            font-size: 6vw;
            padding: 2vw;
        }

        #welcome .button:disabled {
            filter: brightness(0.4);
        }

        #welcome .orbital {
            font-size: 4vw;
            margin-bottom: 2vw;
        }

        #play .button {
            background-color: var(--base-color-bg);
            color: var(--base-color-fg);
            justify-content: center;
            align-items: center;
            font-size: 20vw;
            flex-grow: 1;
            height: 100%;
            border: 0;
            max-width: 32%;
            fill: white;
        }

        #play .button:active {
            filter: contrast(0.5);
        }

        #wait, #getReady, #won, #lost, #gameInProgress {
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .button {
            background-color: var(--base-color-bg);
            font-family: Montserrat, sans-serif;
            display: flex;
            color: var(--base-color-fg);
            justify-content: center;
            align-items: center;
            border: 0;
        }

        .button.retry {
            padding: 10px;
            font-size: 2vw;
        }

        .button:active {
            filter: brightness(1.2);
        }

        .button:focus {
            border: 0;
            outline: 0;
        }

        .fire {
            font-size: 25vw;
        }

        .left {
        }

        .right {
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="allBackground">

        </div>
        <div class="scene active" id="welcome">
            <div class="background"></div>
            Welcome to
            <div class="orbital">ORBITAL</div>
            <button class="button" id="joinButton" onmouseup="onJoinRelease()">
                Join a game
            </button>
        </div>
        <div class="scene" id="wait">
            <div class="background"></div>
            Waiting for an opponent to connect...
        </div>
        <div class="scene" id="getReady">
            <div class="background"></div>
            <p>Waiting for the game to start...</p>
            <p>Starting in ~<span id="startsIn">60</span> sec</p>
        </div>
        <div class="scene" id="play">
            <div class="background"></div>
            <button class="left button" id="leftButton">
                <img src="/static/left-arrow.svg">
            </button>
            <button class="fire button" id="fireButton">
                <img src="/static/target.svg">
            </button>
            <button class="right button" id="rightButton">
                <img src="/static/right-arrow.svg">
            </button>
        </div>
        <div class="scene" id="won">
            <div class="background"></div>
            <p style="color: var(--base-color-bg);">CONGRATULATIONS</p>
            <p>You won !</p>
            <button class="button retry" onclick="activateScene('welcome')">Play again</button>
        </div>
        <div class="scene" id="lost">
            <div class="background"></div>
            <p>GAME OVER</p>
            <p>You died.</p>
            <button class="button retry" onclick="activateScene('welcome')">Play again</button>
        </div>
        <div class="scene" id="gameInProgress">
            <div class="background"></div>
            <p>A game is currently in progress.</p>
            <p>Spectate and be ready for the next game !</p>
            <button class="button retry" onclick="activateScene('welcome')">Try again</button>
        </div>
    </div>
    <script>

      for (var s = 0; s < 10; s++) {
        var strip = document.createElement('div');
        strip.classList.add('strip');
        for (var l = 0; l < 30; l++) {
          var led = document.createElement('div');
          led.classList.add('led');
          strip.appendChild(led);
        }
        document.querySelector('#allBackground').appendChild(strip);
      }

      state = {
        activeScene: 'welcome'
      };

      changeBaseColorFG = (color) => {
        document.documentElement.style.setProperty('--base-color-fg', color);
      };
      changeBaseColorBG = (color) => {
        document.documentElement.style.setProperty('--base-color-bg', color);
      };

      onJoinRelease = () => {
        document.querySelector('#joinButton').setAttribute('disabled', true);
        onJoin();
      };

      onJoinDisappear = () => {
        document.querySelector('#joinButton').removeAttribute('disabled');
      };

      activateScene = (scene) => {
        onJoinDisappear();
        if (!['welcome', 'wait', 'getReady', 'play', 'won', 'lost', 'gameInProgress']
          .includes(scene)) {
          console.error("This scene doesn't exist");
          return;
        }
        if (scene === 'lost' || scene === 'won') {
          window.navigator.vibrate(200);
        }
        if (scene === 'welcome') {
          changeBaseColorBG(baseGray);
        }
        state.activeScene = scene;
        document
          .querySelectorAll('.scene')
          .forEach(e => e.classList.remove('active'));
        document
          .querySelector('#' + scene).classList.add('active');
      };

      baseGray = '#8e8e8e';
      waitTime = 60;

      ws = new WebSocket("ws://" + location.host + "/");

      sendJSON = (message) => () => {
        ws.send(JSON.stringify(message));
      };

      onJoin = sendJSON({cmd: 'join'});
      onLeftPress = sendJSON({cmd: 'press', data: 'left'});
      onLeftRelease = sendJSON({cmd: 'release', data: 'left'});
      onRightPress = sendJSON({cmd: 'press', data: 'right'});
      onRightRelease = sendJSON({cmd: 'release', data: 'right'});
      onFirePress = sendJSON({cmd: 'press', data: 'fire'});
      onFireRelease = sendJSON({cmd: 'release', data: 'fire'});

      var leftDown = (e) => {
        return onLeftPress(e);
      };
      var rightDown = (e) => {
        return onRightPress(e);
      };
      var fireDown = (e) => {
        return onFirePress(e);
      };

      var leftUp = (e) => {
        e.target.blur();
        return onLeftRelease(e);
      };
      var rightUp = (e) => {
        e.target.blur();
        return onRightRelease(e);
      };
      var fireUp = (e) => {
        e.target.blur();
        return onFireRelease(e);
      };
      document.querySelector('#leftButton').addEventListener("mousedown", leftDown);
      document.querySelector('#leftButton').addEventListener("touchstart", leftDown);

      document.querySelector('#fireButton').addEventListener("mousedown", fireDown);
      document.querySelector('#fireButton').addEventListener("touchstart", fireDown);

      document.querySelector('#rightButton').addEventListener("mousedown", rightDown);
      document.querySelector('#rightButton').addEventListener("touchstart", rightDown);


      document.querySelector('#leftButton').addEventListener("mouseup", leftUp);
      document.querySelector('#leftButton').addEventListener("touchend", leftUp);

      document.querySelector('#fireButton').addEventListener("mouseup", fireUp);
      document.querySelector('#fireButton').addEventListener("touchend", fireUp);

      document.querySelector('#rightButton').addEventListener("mouseup", rightUp);
      document.querySelector('#rightButton').addEventListener("touchend", rightUp);


      setWaitTime = (newTime) => {
        waitTime = newTime;
        document.querySelector('#startsIn').innerHTML = newTime;
      };

      var bindings = {
        'ArrowLeft': [onLeftPress, onLeftRelease],
        'a': [onLeftPress, onLeftRelease],

        'ArrowRight': [onRightPress, onRightRelease],
        'd': [onRightPress, onRightRelease],

        ' ': [onFirePress, onFireRelease],
        'Control': [onFirePress, onFireRelease],
        'Shift': [onFirePress, onFireRelease],
        'Alt': [onFirePress, onFireRelease],
        'y': [onFirePress, onFireRelease],
      };

      onKeyDown = (e) => {
        if (state.activeScene !== 'play') {
          return;
        }
        if (e.key in bindings) {
          bindings[e.key][0]();
        }
      };

      onKeyUp = (e) => {
        if (state.activeScene !== 'play') {
          return;
        }
        if (e.key in bindings) {
          bindings[e.key][1]();
        }
      };


      document.addEventListener('keydown', onKeyDown);
      document.addEventListener('keyup', onKeyUp);

      onRecieve = (message) => {
        var json = JSON.parse(message);
        if (!json.cmd) {
          console.error("Invalid message recieved");
          return;
        }
        joinPressed = false;
        switch (json.cmd) {
          case 'welcome': {
            activateScene('welcome');
            changeBaseColorBG(baseGray);
            break;
          }

          case 'wait': {
            activateScene('wait');
            break;
          }

          case 'getReady': {
            activateScene('getReady');
            setWaitTime(json.data);
            changeBaseColorBG(json.color);
            break;
          }

          case 'play': {
            activateScene('play');
            changeBaseColorBG(json.color);
            break;
          }

          case 'won': {
            activateScene('won');
            break;
          }

          case 'lost': {
            activateScene('lost');
            break;
          }

          case 'gameInProgress': {
            activateScene('gameInProgress');
            break;
          }
        }
      };

      ws.onmessage = (evt) => {
        onRecieve(evt.data);
      };

    </script>
</body>
</html>
